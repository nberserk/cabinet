<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="dist/styles.css">
    <title>Tab Hierarchy - Side Panel Test</title>
</head>

<body class="m-0 p-2 bg-gray-100 text-white font-sans">

    <main role="main" aria-label="Tab hierarchy tree">
        <!-- Header with Cabinet Management Link -->
        <div class="flex items-center justify-between mb-3">
            <div>
                <h2 class="text-sm font-medium text-gray-700">Current Window Tabs</h2>
                <p class="text-xs text-gray-500">Organized by relationships</p>
            </div>
            <button id="open-cabinets-btn"
                class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                title="Open Cabinet Management">
                Cabinets
            </button>
        </div>

        <!-- Tab Hierarchy Section -->
        <div id="tab-tree" class="space-y-0.5 min-h-0 overflow-y-auto max-h-screen" role="tree"
            aria-label="Browser tabs organized in hierarchy" tabindex="0">
            <!-- Tab tree will be rendered here -->
        </div>

        <!-- Loading/Error/Empty States -->
        <div id="loading-state" class="hidden text-gray-500 text-sm p-4 text-center" role="status" aria-live="polite">
            <div class="flex items-center justify-center space-x-2">
                <div class="w-4 h-4 border-2 border-gray-300 border-t-blue-500 rounded-full animate-spin"></div>
                <span>Loading tabs...</span>
            </div>
        </div>

        <div id="error-state" class="hidden text-red-600 text-sm p-3 bg-red-50 border border-red-200 rounded-md"
            role="alert" aria-live="assertive">
            <div class="flex items-start space-x-2">
                <svg class="w-4 h-4 text-red-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                        clip-rule="evenodd" />
                </svg>
                <div>
                    <p class="font-medium">Error loading tabs</p>
                    <p id="error-message" class="text-xs mt-1"></p>
                </div>
            </div>
        </div>

        <div id="empty-state" class="hidden text-gray-500 text-sm p-4 text-center" role="status">
            <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p>No tabs found in current window</p>
        </div>
    </main>

    <!-- Context menu (hidden by default) -->
    <div id="context-menu"
        class="hidden absolute bg-white border border-gray-200 rounded-md shadow-lg py-1 z-50 min-w-32" role="menu"
        aria-hidden="true">
        <!-- Context menu items will be populated dynamically -->
    </div>

    <script>
        // Mock Chrome APIs for testing
        if (typeof chrome === 'undefined') {
            window.chrome = {};
        }

        // Override chrome APIs with mock implementations
        window.chrome.runtime = {
            sendMessage: (message) => {
                console.log('Mock chrome.runtime.sendMessage:', message);
                return Promise.resolve({ success: true });
            },
            onMessage: {
                addListener: (callback) => {
                    console.log('Mock chrome.runtime.onMessage.addListener');
                }
            },
            getURL: (path) => path
        };

        window.chrome.tabs = {
            create: (options) => {
                console.log('Mock chrome.tabs.create:', options);
            }
        };

        // Mock tab data for testing
        const mockHierarchyState = {
            rootTabs: [
                {
                    id: 1,
                    title: "GitHub - Your Repository",
                    url: "https://github.com/user/repo",
                    favicon: "https://github.com/favicon.ico",
                    parentId: null,
                    children: [
                        {
                            id: 2,
                            title: "Pull Request #123",
                            url: "https://github.com/user/repo/pull/123",
                            favicon: "https://github.com/favicon.ico",
                            parentId: 1,
                            children: [
                                {
                                    id: 3,
                                    title: "Code Review Comments",
                                    url: "https://github.com/user/repo/pull/123/files",
                                    favicon: "https://github.com/favicon.ico",
                                    parentId: 2,
                                    children: [],
                                    level: 2,
                                    isActive: false,
                                    isPinned: false,
                                    isLoading: false
                                }
                            ],
                            level: 1,
                            isActive: false,
                            isPinned: false,
                            isLoading: false
                        },
                        {
                            id: 4,
                            title: "Issues - Bug Reports",
                            url: "https://github.com/user/repo/issues",
                            favicon: "https://github.com/favicon.ico",
                            parentId: 1,
                            children: [],
                            level: 1,
                            isActive: false,
                            isPinned: true,
                            isLoading: false
                        }
                    ],
                    level: 0,
                    isActive: true,
                    isPinned: false,
                    isLoading: false
                },
                {
                    id: 5,
                    title: "Stack Overflow - JavaScript Question",
                    url: "https://stackoverflow.com/questions/12345/javascript-help",
                    favicon: "https://stackoverflow.com/favicon.ico",
                    parentId: null,
                    children: [
                        {
                            id: 6,
                            title: "MDN Web Docs - Array Methods",
                            url: "https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array",
                            favicon: "https://developer.mozilla.org/favicon.ico",
                            parentId: 5,
                            children: [],
                            level: 1,
                            isActive: false,
                            isPinned: false,
                            isLoading: true
                        }
                    ],
                    level: 2,
                    isActive: false,
                    isPinned: false,
                    isLoading: false
                },
                {
                    id: 7,
                    title: "Google - Search Results",
                    url: "https://www.google.com/search?q=chrome+extension+development",
                    favicon: "https://www.google.com/favicon.ico",
                    parentId: null,
                    children: [],
                    level: 0,
                    isActive: false,
                    isPinned: false,
                    isLoading: false
                }
            ],
            tabCount: 7,
            activeTabId: 1,
            windowId: 1
        };

        // Initialize with mock data
        window.hierarchyState = mockHierarchyState;
        window.currentWindowId = 1;
        window.isLoading = false;
        window.contextMenu = null;
        window.selectedTabId = null;

        // UI elements
        window.tabTreeElement = null;
        window.loadingStateElement = null;
        window.errorStateElement = null;
        window.emptyStateElement = null;
        window.contextMenuElement = null;
        window.openCabinetsBtn = null;
    </script>

    <!-- Include the original sidepanel.js but skip the init function -->
    <script>
        // Copy the functions from sidepanel.js but modify initialization

        // Access global variables
        let hierarchyState = window.hierarchyState;
        let currentWindowId = window.currentWindowId;
        let isLoading = window.isLoading;
        let contextMenu = window.contextMenu;
        let selectedTabId = window.selectedTabId;

        // UI elements
        let tabTreeElement = window.tabTreeElement;
        let loadingStateElement = window.loadingStateElement;
        let errorStateElement = window.errorStateElement;
        let emptyStateElement = window.emptyStateElement;
        let contextMenuElement = window.contextMenuElement;
        let openCabinetsBtn = window.openCabinetsBtn;

        // Initialize DOM elements
        function initializeElements() {
            tabTreeElement = document.getElementById('tab-tree');
            loadingStateElement = document.getElementById('loading-state');
            errorStateElement = document.getElementById('error-state');
            emptyStateElement = document.getElementById('empty-state');
            contextMenuElement = document.getElementById('context-menu');
            openCabinetsBtn = document.getElementById('open-cabinets-btn');

            if (!tabTreeElement || !loadingStateElement || !errorStateElement || !emptyStateElement ||
                !contextMenuElement || !openCabinetsBtn) {
                throw new Error('Required DOM elements not found');
            }
        }

        // State management functions
        function showLoadingState() {
            isLoading = true;
            loadingStateElement.classList.remove('hidden');
            tabTreeElement.classList.add('hidden');
            errorStateElement.classList.add('hidden');
            emptyStateElement.classList.add('hidden');
        }

        function hideLoadingState() {
            isLoading = false;
            loadingStateElement.classList.add('hidden');
        }

        function showErrorState(message) {
            errorStateElement.classList.remove('hidden');
            tabTreeElement.classList.add('hidden');
            loadingStateElement.classList.add('hidden');
            emptyStateElement.classList.add('hidden');

            const errorMessageElement = document.getElementById('error-message');
            if (errorMessageElement) {
                errorMessageElement.textContent = message;
            }
        }

        function showEmptyState() {
            emptyStateElement.classList.remove('hidden');
            tabTreeElement.classList.add('hidden');
            errorStateElement.classList.add('hidden');
            loadingStateElement.classList.add('hidden');
        }

        function showTabTree() {
            tabTreeElement.classList.remove('hidden');
            errorStateElement.classList.add('hidden');
            loadingStateElement.classList.add('hidden');
            emptyStateElement.classList.add('hidden');
        }

        // Main rendering function
        function renderHierarchy() {
            try {
                //console.log('renderHierarchy called with state:', hierarchyState);

                if (!hierarchyState) {
                    console.log('No hierarchy state, showing empty state');
                    showEmptyState();
                    return;
                }

                if (!hierarchyState.rootTabs || !Array.isArray(hierarchyState.rootTabs)) {
                    console.log('Invalid rootTabs, showing empty state');
                    showEmptyState();
                    return;
                }

                if (hierarchyState.rootTabs.length === 0) {
                    console.log('No root tabs, showing empty state');
                    showEmptyState();
                    return;
                }

                showTabTree();
                tabTreeElement.innerHTML = '';

                console.log('Rendering hierarchy with', hierarchyState.rootTabs.length, 'root tabs');

                hierarchyState.rootTabs.forEach((tab, index) => {
                    const isLast = index === hierarchyState.rootTabs.length - 1;
                    renderTabNode(tabTreeElement, tab, 0, isLast, []);
                });

                // Set focus to first tab for keyboard navigation
                const firstTab = tabTreeElement.querySelector('.tree-node');
                if (firstTab) {
                    firstTab.setAttribute('tabindex', '0');
                }

            } catch (error) {
                console.error('Render error:', error);
                showErrorState('Failed to render tab hierarchy: ' + error.message);
            }
        }

        // Render individual tab node with tree structure
        function renderTabNode(container, tabNode, depth, isLast = false, ancestorLines = []) {
            if (!tabNode || !tabNode.id) {
                console.warn('Invalid tab node:', tabNode);
                return;
            }

            // Ensure children array exists
            if (!tabNode.children) {
                tabNode.children = [];
            }

            // Create main tab element
            const tabElement = document.createElement('div');
            tabElement.className = 'tree-node';
            tabElement.setAttribute('data-tab-id', tabNode.id);
            tabElement.setAttribute('data-level', depth);
            tabElement.setAttribute('role', 'treeitem');
            tabElement.setAttribute('aria-level', depth + 1);
            tabElement.setAttribute('aria-expanded', tabNode.children.length > 0 ? 'true' : 'false');
            tabElement.setAttribute('tabindex', '-1');

            if (tabNode.isActive) {
                tabElement.classList.add('active');
                tabElement.setAttribute('aria-selected', 'true');
            }

            // Tab content wrapper
            const tabContent = document.createElement('div');
            tabContent.className = 'tree-content';
            
            // Add padding based on hierarchy depth using Tailwind classes
            const paddingClasses = ['pl-0', 'pl-4', 'pl-8', 'pl-12', 'pl-16', 'pl-20'];
            const paddingClass = paddingClasses[Math.min(depth, paddingClasses.length - 1)];
            tabContent.classList.add(paddingClass);

            // Favicon
            const favicon = document.createElement('img');
            favicon.className = 'tab-favicon';
            favicon.src = tabNode.favicon || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><rect width="16" height="16" fill="%23ddd"/></svg>';
            favicon.alt = '';
            favicon.setAttribute('aria-hidden', 'true');
            tabContent.appendChild(favicon);

            // Title
            const title = document.createElement('div');
            title.className = 'tab-title';
            title.textContent = tabNode.title || tabNode.url || 'Untitled';
            title.setAttribute('title', tabNode.title || tabNode.url || 'Untitled');
            tabContent.appendChild(title);
            
            // Depth indicator
            const depthIndicator = document.createElement('span');
            depthIndicator.className = 'text-xs text-gray-400 ml-2 font-mono';
            depthIndicator.textContent = `L${depth}`;
            depthIndicator.setAttribute('title', `Hierarchy level: ${depth}`);
            tabContent.appendChild(depthIndicator);

            // Tab indicators (pinned, loading)
            const indicators = document.createElement('div');
            indicators.className = 'tab-indicators';

            if (tabNode.isPinned) {
                const pinnedIndicator = document.createElement('div');
                pinnedIndicator.className = 'pinned-indicator';
                pinnedIndicator.setAttribute('title', 'Pinned tab');
                pinnedIndicator.setAttribute('aria-label', 'Pinned tab');
                indicators.appendChild(pinnedIndicator);
            }

            if (tabNode.isLoading) {
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'loading-indicator';
                loadingIndicator.setAttribute('title', 'Loading...');
                loadingIndicator.setAttribute('aria-label', 'Loading');
                indicators.appendChild(loadingIndicator);
            }

            tabContent.appendChild(indicators);

            // Close button
            const closeBtn = document.createElement('button');
            closeBtn.className = 'w-4 h-4 bg-gray-400 hover:bg-gray-500 text-white text-xs rounded-sm border-none cursor-pointer ml-1 opacity-0 transition-all duration-200 flex-shrink-0 leading-none';
            closeBtn.textContent = 'âœ•';
            closeBtn.setAttribute('title', 'Close tab');
            closeBtn.setAttribute('aria-label', `Close ${tabNode.title || 'tab'}`);
            closeBtn.onclick = (e) => {
                e.stopPropagation();
                handleCloseTab(tabNode.id);
            };
            tabContent.appendChild(closeBtn);

            // Event handlers - use mousedown for faster response
            tabContent.onmousedown = (e) => {
                // Only handle left mouse button
                if (e.button === 0) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleTabClick(tabNode.id);
                }
            };
            
            // Touch support
            tabContent.ontouchstart = (e) => {
                e.preventDefault();
                e.stopPropagation();
                handleTabClick(tabNode.id);
            };
            
            // Prevent click event to avoid double firing
            tabContent.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
            };

            tabContent.oncontextmenu = (e) => {
                e.preventDefault();
                showContextMenu(e, tabNode);
            };

            tabElement.appendChild(tabContent);
            container.appendChild(tabElement);

            // Render children
            if (tabNode.children && tabNode.children.length > 0) {
                const newAncestorLines = [...ancestorLines];
                newAncestorLines[depth] = !isLast;

                tabNode.children.forEach((child, index) => {
                    const isLastChild = index === tabNode.children.length - 1;
                    renderTabNode(container, child, depth + 1, isLastChild, newAncestorLines);
                });
            }
        }

        // Mock tab interaction handlers
        function handleTabClick(tabId) {
            console.log('Tab clicked:', tabId);
            // Update active state for demo
            updateActiveTab(tabId);
        }

        function handleCloseTab(tabId) {
            console.log('Close tab:', tabId);
            // Check if this tab has children - if so, use cascading delete
            const tabNode = findTabNodeById(tabId);
            if (tabNode && tabNode.children && tabNode.children.length > 0) {
                console.log('Cascading delete for parent tab:', tabId);
                removeTabAndChildrenFromMockData(tabId);
            } else {
                console.log('Regular close for leaf tab:', tabId);
                removeTabFromMockData(tabId);
            }
            renderHierarchy();
        }

        // Helper function to find tab node by ID in the hierarchy
        function findTabNodeById(tabId) {
            if (!window.hierarchyState || !window.hierarchyState.rootTabs) return null;
            
            function searchInTabs(tabs) {
                for (const tab of tabs) {
                    if (tab.id === tabId) return tab;
                    if (tab.children) {
                        const found = searchInTabs(tab.children);
                        if (found) return found;
                    }
                }
                return null;
            }
            
            return searchInTabs(window.hierarchyState.rootTabs);
        }

        function removeTabAndChildrenFromMockData(tabId) {
            function removeFromTabs(tabs) {
                for (let i = tabs.length - 1; i >= 0; i--) {
                    if (tabs[i].id === tabId) {
                        // Remove this tab and all its children
                        tabs.splice(i, 1);
                        return true;
                    }
                    if (tabs[i].children && removeFromTabs(tabs[i].children)) {
                        return true;
                    }
                }
                return false;
            }
            removeFromTabs(window.hierarchyState.rootTabs);
        }

        function updateActiveTab(tabId) {
            function updateTabActive(tabs) {
                tabs.forEach(tab => {
                    tab.isActive = tab.id === tabId;
                    if (tab.children) {
                        updateTabActive(tab.children);
                    }
                });
            }
            updateTabActive(window.hierarchyState.rootTabs);
            hierarchyState = window.hierarchyState; // Update local reference
            renderHierarchy();
        }

        function removeTabFromMockData(tabId) {
            function removeFromTabs(tabs) {
                for (let i = tabs.length - 1; i >= 0; i--) {
                    if (tabs[i].id === tabId) {
                        tabs.splice(i, 1);
                        return true;
                    }
                    if (tabs[i].children && removeFromTabs(tabs[i].children)) {
                        return true;
                    }
                }
                return false;
            }
            removeFromTabs(window.hierarchyState.rootTabs);
            hierarchyState = window.hierarchyState; // Update local reference
        }

        // Context menu (simplified for demo)
        function showContextMenu(e, tabNode) {
            console.log('Context menu for tab:', tabNode.id);
        }

        // Cabinet button
        function setupCabinetButton() {
            openCabinetsBtn.addEventListener('click', () => {
                console.log('Open Cabinet Management');
                alert('Cabinet Management would open here');
            });
        }

        // Initialize the test page
        function init() {
            try {
                // Refresh local references to global variables
                hierarchyState = window.hierarchyState;
                currentWindowId = window.currentWindowId;
                isLoading = window.isLoading;

                initializeElements();
                setupCabinetButton();
                renderHierarchy();
                console.log('Test page initialized successfully');
            } catch (error) {
                console.error('Init error:', error);
                showErrorState('Failed to initialize: ' + error.message);
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>